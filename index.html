<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸´åºŠçº§ï¼šçµé¾Ÿå…«æ³•ä¸å­åˆæµæ³¨åŠ¨æ€ç½—ç›˜</title>
    <script src="lunar.min.js"></script>
    <style>
        :root {
            --bg-color: #f2ede4;
            --accent-color: #8b0000;
            --sub-accent: #333;
            --text-color: #1a1a1a;
            --border-color: #c5b699;
            --gold-accent: #a67c00;
        }

        body {
            margin: 0;
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            min-height: 100dvh;
            background-color: var(--bg-color);
            font-family: "Semicolon", "STKaiti", "KaiTi", serif;
            color: var(--text-color);
            overflow-y: auto;
            overflow-x: hidden;
            touch-action: pan-y;
            box-sizing: border-box;
        }

        .header {
            text-align: center;
            margin: 5px 0;
            z-index: 10;
            flex-shrink: 0;
        }

        .header h1 {
            margin: 0;
            font-size: clamp(1rem, 4vw, 1.4rem);
            letter-spacing: 2px;
            color: var(--accent-color);
        }

        .compass-container {
            position: relative;
            width: min(92vw, 55vh);
            height: min(92vw, 55vh);
            max-width: 480px;
            max-height: 480px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .layer {
            position: absolute;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            cursor: grab;
            user-select: none;
            transition: transform 0.6s cubic-bezier(0.25, 0.1, 0.25, 1);
            background: #fffefb;
            border: 1px solid var(--border-color);
        }

        .layer:active {
            cursor: grabbing;
            transition: none;
        }

        .layer-0 {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .layer-1 {
            width: 82%;
            height: 82%;
            z-index: 2;
            border-color: var(--gold-accent);
        }

        .layer-2 {
            width: 64%;
            height: 64%;
            z-index: 3;
            background: #fdfaf2;
        }

        .layer-3 {
            width: 38%;
            height: 38%;
            z-index: 4;
            background: #fcfcfc;
            font-weight: bold;
        }

        .center-dot {
            position: absolute;
            width: 16%;
            height: 16%;
            background: var(--accent-color);
            border: 2px solid #fff;
            border-radius: 50%;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .label {
            position: absolute;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            pointer-events: none;
            width: 70px;
        }

        .layer-0 .label {
            padding-top: 5px;
            font-size: 0.6rem;
        }

        .layer-1 .label {
            padding-top: 8px;
            font-size: 0.75rem;
            color: var(--gold-accent);
        }

        .layer-2 .label {
            padding-top: 10px;
            font-size: 0.8rem;
        }

        .layer-3 .label {
            padding-top: 12px;
            font-size: 1rem;
            color: var(--accent-color);
        }

        .sub-info {
            font-size: 0.5rem;
            opacity: 0.8;
            margin-top: 1px;
        }

        .points-list {
            font-size: 0.45rem;
            color: #666;
            width: 45px;
            line-height: 1;
            margin-top: 2px;
        }

        .indicator {
            position: absolute;
            top: -10px;
            width: 2px;
            height: 25px;
            background: var(--accent-color);
            z-index: 10;
        }

        .indicator::after {
            content: "â–¼";
            position: absolute;
            bottom: -12px;
            left: -6px;
            color: var(--accent-color);
            font-size: 12px;
        }

        .controls {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            z-index: 20;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        button {
            padding: 6px 10px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            height: 30px;
            line-height: 18px;
            box-sizing: border-box;
            white-space: nowrap;
        }

        button.btn-alt {
            background: var(--gold-accent);
        }

        .info-panel {
            margin-top: 8px;
            padding: 8px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            width: 90%;
            max-width: 480px;
            font-size: 0.75rem;
            line-height: 1.5;
            border-left: 4px solid var(--accent-color);
        }

        .highlight {
            color: var(--accent-color);
            font-weight: bold;
        }

        .gold-highlight {
            color: var(--gold-accent);
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>åŠ¨æ€çµé¾Ÿå…«æ³• Â· å­åˆæµæ³¨ç½—ç›˜</h1>
    </div>

    <div class="compass-container" id="compass">
        <div class="indicator"></div>

        <div class="layer layer-0" id="layer-0"></div>
        <div class="layer layer-1" id="layer-1"></div>
        <div class="layer layer-2" id="layer-2"></div>
        <div class="layer layer-3" id="layer-3"></div>

        <div class="center-dot">åŒ»é“<br>åˆä¸€</div>
    </div>

    <div class="controls">
        <button class="btn-alt" onclick="calculateAndAlign()">å½“å‰å¼€ç©´å®æ—¶æŸ¥è¯¢</button>
        <button onclick="setCondition('excess')">å®ç—‡</button>
        <button onclick="setCondition('deficiency')">è™šç—‡</button>
        <button onclick="setCondition('normal')">ä¸å®ä¸è™š</button>
    </div>

    <div class="controls" style="margin-top: 5px;">
        <input type="datetime-local" id="customDateTime"
            style="padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); font-size: 0.75rem; height: 30px;">
        <button onclick="calculateForCustomDate()">æŒ‡å®šæ—¶é—´æŸ¥è¯¢</button>
    </div>

    <div class="info-panel" id="info">
        <b>æ“ä½œè¯´æ˜</b>ï¼šæœ¬ç½—ç›˜å·²åŠ å…¥<b>æ—¥å¹²æ”¯è®¡ç®—é€»è¾‘</b>ã€‚ç‚¹å‡»â€œå½“å‰å¼€ç©´â€å°†è‡ªåŠ¨æ ¹æ®å®æ—¶å†æ³•æ¨ç®—å­åˆæµæ³¨å¼€ç©´ä¸çµé¾Ÿå…«æ³•å¦è±¡ã€‚
    </div>

    <script>
        // çµé¾Ÿå…«æ³•å¸¸é‡é…ç½®
        const STEMS = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"];
        const BRANCHES = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"];

        // çµé¾Ÿå…«æ³•é…æ•°
        // é€æ—¥å¹²æ”¯é…æ•°ï¼ˆå…«æ³•é€æ—¥å¹²æ”¯æ­Œï¼‰
        const dayStemValues = { "ç”²": 10, "å·±": 10, "ä¹™": 9, "åºš": 9, "ä¸": 8, "å£¬": 8, "æˆŠ": 7, "ç™¸": 7, "ä¸™": 7, "è¾›": 7 };
        const dayBranchValues = { "è¾°": 10, "æˆŒ": 10, "ä¸‘": 10, "æœª": 10, "ç”³": 9, "é…‰": 9, "å¯…": 8, "å¯": 8, "å·³": 7, "åˆ": 7, "äº¥": 7, "å­": 7 };

        // ä¸´æ—¶å¹²æ”¯é…æ•°ï¼ˆå…«æ³•ä¸´æ—¶å¹²æ”¯æ­Œï¼‰
        const hourStemValues = { "ç”²": 9, "å·±": 9, "ä¹™": 8, "åºš": 8, "ä¸™": 7, "è¾›": 7, "ä¸": 6, "å£¬": 6, "æˆŠ": 5, "ç™¸": 5 };
        const hourBranchValues = { "å­": 9, "åˆ": 9, "ä¸‘": 8, "æœª": 8, "å¯…": 7, "ç”³": 7, "å¯": 6, "é…‰": 6, "è¾°": 5, "æˆŒ": 5, "å·³": 4, "äº¥": 4 };

        // å¦è±¡å¯¹åº”ç©´ä½ (1-9) - çµé¾Ÿå…«æ³•
        // æ­Œè¯€ï¼šåä¸€è”ç”³è„‰ï¼Œç…§æµ·å¤äºŒäº”ï¼Œéœ‡ä¸‰å±å¤–å…³ï¼Œå·½å››ä¸´æ³£æ•°ï¼Œä¹¾å…­æ˜¯å…¬å­™ï¼Œå…‘ä¸ƒåæºªåºœï¼Œè‰®å…«ç³»å†…å…³ï¼Œç¦»ä¹åˆ—ç¼ºä¸»ã€‚
        const trigramPoints = {
            1: { m: 'ç”³è„‰', s: 'é˜³è··', d: 'åä¸€' },
            2: { m: 'ç…§æµ·', s: 'é˜´è··', d: 'å¤äºŒ' },
            3: { m: 'å¤–å…³', s: 'é˜³ç»´', d: 'éœ‡ä¸‰' },
            4: { m: 'ä¸´æ³£', s: 'å¸¦è„‰', d: 'å·½å››' },
            5: { m: 'ç…§æµ·', s: 'é˜´è··', d: 'ä¸­äº”' }, // äº”æœ¨å±…ä¸­ï¼Œå¯„äºå¤å±€ (åŒå¤äºŒ)
            6: { m: 'å…¬å­™', s: 'å†²è„‰', d: 'ä¹¾å…­' },
            7: { m: 'åæºª', s: 'ç£è„‰', d: 'å…‘ä¸ƒ' },
            8: { m: 'å†…å…³', s: 'é˜´ç»´', d: 'è‰®å…«' },
            9: { m: 'åˆ—ç¼º', s: 'ä»»è„‰', d: 'ç¦»ä¹' }
        };

        // ç½—ç›˜å…«å¦æ˜¾ç¤ºé¡ºåºï¼ˆåå¤©å…«å¦ï¼Œä»å1å¼€å§‹é¡ºæ—¶é’ˆï¼šåè‰®éœ‡å·½ç¦»å¤å…‘ä¹¾ï¼‰
        // å¯¹åº”åœ°æ”¯ï¼šå­(å), ä¸‘å¯…(è‰®), å¯(éœ‡), è¾°å·³(å·½), åˆ(ç¦»), æœªç”³(å¤), é…‰(å…‘), æˆŒäº¥(ä¹¾)
        const compassOrder = [1, 8, 3, 4, 9, 2, 7, 6];

        // é£è…¾å…«æ³• - ç›´æ¥ç”¨æ—¶å¹²å†³å®šå¼€ç©´
        const feitengPoints = {
            "ç”²": { m: 'å…¬å­™', s: 'å†²è„‰', d: 'ä¹¾å…­' },
            "ä¹™": { m: 'ç”³è„‰', s: 'é˜³è··', d: 'å¤äºŒ' },
            "ä¸™": { m: 'å†…å…³', s: 'é˜´ç»´', d: 'è‰®å…«' },
            "ä¸": { m: 'ç…§æµ·', s: 'é˜´è··', d: 'åä¸€' },
            "æˆŠ": { m: 'ä¸´æ³£', s: 'å¸¦è„‰', d: 'å·½å››' },
            "å·±": { m: 'åˆ—ç¼º', s: 'ä»»è„‰', d: 'å…‘ä¸ƒ' },
            "åºš": { m: 'å¤–å…³', s: 'é˜³ç»´', d: 'éœ‡ä¸‰' },
            "è¾›": { m: 'åæºª', s: 'ç£è„‰', d: 'ç¦»ä¹' },
            "å£¬": { m: 'å…¬å­™', s: 'å†²è„‰', d: 'ä¹¾å…­' },
            "ç™¸": { m: 'ç”³è„‰', s: 'é˜³è··', d: 'å¤äºŒ' }
        };

        // çº³ç”²æ³• - æ—¥å¹²å¯¹åº”çš„å¼€ç©´
        // çº³ç”²æ³•å–ç©´è¡¨ - æ ¹æ®æ—¥å¤©å¹²å’Œæ—¶åœ°æ”¯
        const naJiaPoints = {
            "ç”²": {
                "å­": "é˜³è¾…",
                "ä¸‘": "è¡Œé—´",
                "å¯…": "å°æµ·",
                "å¯": "ç¥é—¨",
                "è¾°": "æ”¯æ²Ÿ",
                "å·³": "å•†ä¸˜/éšç™½",
                "åˆ": "æ— ",
                "æœª": "å°ºæ³½/é±¼é™…",
                "ç”³": "æ— ",
                "é…‰": "ä¸­å†²/å¤ªæºª",
                "æˆŒ": "çªé˜´",
                "äº¥": "ä¸­å°"
            },
            "ä¹™": {
                "å­": "å‰è°·",
                "ä¸‘": "å°‘æµ·",
                "å¯…": "é™·è°·",
                "å¯": "é—´ä½¿",
                "è¾°": "é˜³æºª/å•†é˜³",
                "å·³": "æ— ",
                "åˆ": "å§”ä¸­/é€šè°·",
                "æœª": "æ— ",
                "ç”³": "æ¶²é—¨/ä¸´æ³£",
                "é…‰": "å¤§æ•¦",
                "æˆŒ": "é˜³è°·",
                "äº¥": "å°‘åºœ"
            },
            "ä¸™": {
                "å­": "è¶³ä¸‰é‡Œ",
                "ä¸‘": "å¤ªç™½",
                "å¯…": "å¤©äº•",
                "å¯": "ç»æ¸ /å°‘å•†",
                "è¾°": "æ— ",
                "å·³": "é˜³è°·/ç„¶è°·",
                "åˆ": "æ— ",
                "æœª": "åŠ³å®«/å¤ªå†²",
                "ç”³": "å°‘æ³½",
                "é…‰": "çµé“",
                "æˆŒ": "å†…åº­",
                "äº¥": "é˜´é™µ"
            },
            "ä¸": {
                "å­": "ä¸‰é—´",
                "ä¸‘": "æ›²æ³½",
                "å¯…": "æ˜†ä»‘",
                "å¯": "æ— ",
                "è¾°": "é˜³è°·/ç„¶è°·",
                "å·³": "æ— ",
                "åˆ": "ä¸­æ¸š/åæºª",
                "æœª": "å°‘å†²",
                "ç”³": "è§£æºª",
                "é…‰": "å¤§éƒ½",
                "æˆŒ": "æ›²æ± ",
                "äº¥": "å¤ªæ¸Š"
            },
            "æˆŠ": {
                "å­": "å…³å†²",
                "ä¸‘": "å¤æºœ",
                "å¯…": "æ— ",
                "å¯": "æ›²æ³‰",
                "è¾°": "æ— ",
                "å·³": "å¤§é™µ",
                "åˆ": "å†å…‘",
                "æœª": "æ— ",
                "ç”³": "äºŒé—´",
                "é…‰": "æ— ",
                "æˆŒ": "äº¬éª¨",
                "äº¥": "æ¶Œæ³‰"
            },
            "å·±": {
                "å­": "é˜³è¾…",
                "ä¸‘": "è¡Œé—´",
                "å¯…": "å°æµ·",
                "å¯": "ç¥é—¨",
                "è¾°": "æ”¯æ²Ÿ",
                "å·³": "éšç™½/å•†ä¸˜",
                "åˆ": "æ— ",
                "æœª": "é±¼é™…/å°ºæ³½",
                "ç”³": "æ— ",
                "é…‰": "å¤ªæºª/ä¸­å†²",
                "æˆŒ": "çªé˜´",
                "äº¥": "ä¸­å°"
            },
            "åºš": {
                "å­": "å‰è°·",
                "ä¸‘": "å°‘æµ·",
                "å¯…": "é™·è°·",
                "å¯": "é—´ä½¿",
                "è¾°": "å•†é˜³/é˜³æºª",
                "å·³": "æ— ",
                "åˆ": "é€šè°·/å§”ä¸­",
                "æœª": "æ— ",
                "ç”³": "ä¸´æ³£/æ¶²é—¨",
                "é…‰": "å¤§æ•¦",
                "æˆŒ": "é˜³è°·",
                "äº¥": "å°‘åºœ"
            },
            "è¾›": {
                "å­": "è¶³ä¸‰é‡Œ",
                "ä¸‘": "å¤ªç™½",
                "å¯…": "å¤©äº•",
                "å¯": "å°‘å•†/ç»æ¸ ",
                "è¾°": "æ— ",
                "å·³": "é˜³è°·/ç„¶è°·",
                "åˆ": "æ— ",
                "æœª": "å¤ªå†²/åŠ³å®«",
                "ç”³": "å°‘æ³½",
                "é…‰": "çµé“",
                "æˆŒ": "å†…åº­",
                "äº¥": "é˜´é™µ"
            },
            "å£¬": {
                "å­": "ä¸‰é—´",
                "ä¸‘": "æ›²æ³½",
                "å¯…": "è‡³é˜´/æ˜†ä»‘",
                "å¯": "æ— ",
                "è¾°": "ä¾ æºª/é˜³æºª",
                "å·³": "æ— ",
                "åˆ": "åæºª/ä¸­æ¸š",
                "æœª": "å°‘å†²",
                "ç”³": "è§£æºª",
                "é…‰": "å¤§éƒ½",
                "æˆŒ": "æ›²æ± ",
                "äº¥": "å¤ªæ¸Š"
            },
            "ç™¸": {
                "å­": "å…³å†²",
                "ä¸‘": "å¤æºœ",
                "å¯…": "æ— ",
                "å¯": "æ›²æ³‰",
                "è¾°": "æ— ",
                "å·³": "å¤§é™µ",
                "åˆ": "å†å…‘",
                "æœª": "æ— ",
                "ç”³": "äºŒé—´",
                "é…‰": "æ— ",
                "æˆŒ": "æŸéª¨",
                "äº¥": "æ¶Œæ³‰"
            }
        };

        // å­åˆæµæ³¨çº³å­æ³• - æ—¶è¾°å¯¹åº”çš„å¼€ç©´
        const naZiPoints = [
            { time: 'å­', organ: 'èƒ†ç»', wuxing: 'æœ¨', deficiency: 'ä¾ æºª', excess: 'é˜³è¾…', ben: 'ä¸´æ³£', yuan: 'ä¸˜è™š' },
            { time: 'ä¸‘', organ: 'è‚ç»', wuxing: 'æœ¨', deficiency: 'æ›²æ³‰', excess: 'è¡Œé—´', ben: 'å¤§æ•¦', yuan: 'å¤ªå†²' },
            { time: 'å¯…', organ: 'è‚ºç»', wuxing: 'é‡‘', deficiency: 'å¤ªæ¸Š', excess: 'å°ºæ³½', ben: 'ç»æ¸ ', yuan: 'å¤ªæ¸Š' },
            { time: 'å¯', organ: 'å¤§è‚ ', wuxing: 'é‡‘', deficiency: 'æ›²æ± ', excess: 'äºŒé—´', ben: 'å•†é˜³', yuan: 'åˆè°·' },
            { time: 'è¾°', organ: 'èƒƒç»', wuxing: 'åœŸ', deficiency: 'è§£æºª', excess: 'å‰å…‘', ben: 'ä¸‰é‡Œ', yuan: 'å†²é˜³' },
            { time: 'å·³', organ: 'è„¾ç»', wuxing: 'åœŸ', deficiency: 'å¤§éƒ½', excess: 'å•†ä¸˜', ben: 'å¤ªç™½', yuan: 'å¤ªç™½' },
            { time: 'åˆ', organ: 'å¿ƒç»', wuxing: 'ç«', deficiency: 'å°‘å†²', excess: 'ç¥é—¨', ben: 'å°‘åºœ', yuan: 'ç¥é—¨' },
            { time: 'æœª', organ: 'å°è‚ ', wuxing: 'ç«', deficiency: 'åæºª', excess: 'å°æµ·', ben: 'é˜³è°·', yuan: 'è…•éª¨' },
            { time: 'ç”³', organ: 'è†€èƒ±', wuxing: 'æ°´', deficiency: 'è‡³é˜´', excess: 'æŸéª¨', ben: 'é€šè°·', yuan: 'äº¬éª¨' },
            { time: 'é…‰', organ: 'è‚¾ç»', wuxing: 'æ°´', deficiency: 'å¤æºœ', excess: 'æ¶Œæ³‰', ben: 'é˜´è°·', yuan: 'å¤ªæºª' },
            { time: 'æˆŒ', organ: 'å¿ƒåŒ…', wuxing: 'ç«', deficiency: 'ä¸­å†²', excess: 'å¤§é™µ', ben: 'å¤§é™µ', yuan: 'å¤§é™µ' },
            { time: 'äº¥', organ: 'ä¸‰ç„¦', wuxing: 'ç«', deficiency: 'ä¸­æ¸š', excess: 'å…³å†²', ben: 'å…³å†²', yuan: 'é˜³æ± ' }
        ];

        const layersConfig = [
            { id: 'layer-0', items: ['23-1 å­', '1-3 ä¸‘', '3-5 å¯…', '5-7 å¯', '7-9 è¾°', '9-11 å·³', '11-13 åˆ', '13-15 æœª', '15-17 ç”³', '17-19 é…‰', '19-21 æˆŒ', '21-23 äº¥'] },
            { id: 'layer-1', items: compassOrder.map(k => trigramPoints[k]) }, // ä½¿ç”¨åå¤©å…«å¦é¡ºåº
            {
                id: 'layer-2', items: [
                    { n: 'èƒ†ç»', p: ['çªé˜´', 'ä¾ æºª', 'ä¸´æ³£', 'é˜³è¾…', 'é˜³é™µæ³‰'] }, { n: 'è‚ç»', p: ['å¤§æ•¦', 'è¡Œé—´', 'å¤ªå†²', 'ä¸­å°', 'æ›²æ³‰'] },
                    { n: 'è‚ºç»', p: ['å°‘å•†', 'é±¼é™…', 'å¤ªæ¸Š', 'ç»æ¸ ', 'å°ºæ³½'] }, { n: 'å¤§è‚ ', p: ['å•†é˜³', 'äºŒé—´', 'ä¸‰é—´', 'é˜³æºª', 'æ›²æ± '] },
                    { n: 'èƒƒç»', p: ['å‰å…‘', 'å†…åº­', 'é™·è°·', 'è§£æºª', 'è¶³ä¸‰é‡Œ'] }, { n: 'è„¾ç»', p: ['éšç™½', 'å¤§éƒ½', 'å¤ªç™½', 'å•†ä¸˜', 'é˜´é™µæ³‰'] },
                    { n: 'å¿ƒç»', p: ['å°‘å†²', 'å°‘åºœ', 'ç¥é—¨', 'çµé“', 'å°‘æµ·'] }, { n: 'å°è‚ ', p: ['å°‘æ³½', 'å‰è°·', 'åæºª', 'é˜³è°·', 'å°æµ·'] },
                    { n: 'è†€èƒ±', p: ['è‡³é˜´', 'é€šè°·', 'æŸéª¨', 'æ˜†ä»‘', 'å§”ä¸­'] }, { n: 'è‚¾ç»', p: ['æ¶Œæ³‰', 'ç„¶è°·', 'å¤ªæºª', 'å¤æºœ', 'é˜´è°·'] },
                    { n: 'å¿ƒåŒ…', p: ['ä¸­å†²', 'åŠ³å®«', 'å¤§é™µ', 'é—´ä½¿', 'æ›²æ³½'] }, { n: 'ä¸‰ç„¦', p: ['å…³å†²', 'æ¶²é—¨', 'ä¸­æ¸š', 'æ”¯æ²Ÿ', 'å¤©äº•'] }
                ]
            },
            { id: 'layer-3', items: BRANCHES }
        ];

        const state = { rotations: [0, 0, 0, 0], isDragging: false, currentLayer: null, startAngle: 0, baseRotation: 0, condition: 'normal' }; // condition: excess(å®ç—‡), deficiency(è™šç—‡), normal(ä¸å®ä¸è™š)

        // æ—¥å¹²æ”¯è®¡ç®—ç®—æ³• - ä½¿ç”¨ lunar-javascript åº“
        function getGanZhi(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1; // è½¬æ¢ä¸º1-12æœˆ
            const day = date.getDate();
            const hour = date.getHours();

            // ä½¿ç”¨ lunar-javascript åº“è®¡ç®—æ—¥å¹²æ”¯
            const lunar = Lunar.fromDate(date);
            const dayGanZhi = lunar.getDayInGanZhi();
            const dayStem = dayGanZhi.substring(0, 1);
            const dayBranch = dayGanZhi.substring(1, 2);

            // è®¡ç®—æ—¶å¹²æ”¯
            const hourIndex = Math.floor(((hour + 1) % 24) / 2);
            const hourBranch = BRANCHES[hourIndex];

            // æ—¶å¹² = (æ—¥å¹²åº*2 + æ—¶æ”¯åº) % 10
            const dayStemIndex = STEMS.indexOf(dayStem);
            const hourStemIndex = ((dayStemIndex * 2 + hourIndex) % 10 + 10) % 10;
            const hourStem = STEMS[hourStemIndex];

            return { dayStem, dayBranch, hourStem, hourBranch, hourIndex };
        }

        function init() {
            layersConfig.forEach((config, idx) => {
                const el = document.getElementById(config.id);
                const count = config.items.length;
                config.items.forEach((item, i) => {
                    const label = document.createElement('div');
                    label.className = 'label';
                    if (idx === 1) {
                        label.innerHTML = `<span>${item.m}</span><span class="sub-info">${item.s}</span><span class="sub-info">${item.d}</span>`;
                    } else if (idx === 2) {
                        label.innerHTML = `<span class="highlight">${item.n}</span><div class="points-list">${item.p.join(' ')}</div>`;
                    } else {
                        label.innerText = item;
                    }
                    label.style.transform = `rotate(${(i * 360) / count}deg)`;
                    el.appendChild(label);
                });
                el.addEventListener('mousedown', (e) => startDrag(e, idx));
                el.addEventListener('touchstart', (e) => startDrag(e, idx), { passive: false });
            });
            window.addEventListener('mousemove', handleDrag);
            window.addEventListener('touchmove', handleDrag, { passive: false });
            window.addEventListener('mouseup', endDrag);
            window.addEventListener('touchend', endDrag);
        }

        function getAngle(clientX, clientY) {
            const rect = document.getElementById('compass').getBoundingClientRect();
            return Math.atan2(clientY - (rect.top + rect.height / 2), clientX - (rect.left + rect.width / 2)) * 180 / Math.PI;
        }

        function startDrag(e, idx) {
            state.isDragging = true; state.currentLayer = idx;
            const pos = e.touches ? e.touches[0] : e;
            state.startAngle = getAngle(pos.clientX, pos.clientY);
            state.baseRotation = state.rotations[idx];
            e.preventDefault();
        }

        function handleDrag(e) {
            if (!state.isDragging) return;
            const pos = e.touches ? e.touches[0] : e;
            state.rotations[state.currentLayer] = state.baseRotation + (getAngle(pos.clientX, pos.clientY) - state.startAngle);
            updateUI();
        }

        function endDrag() { state.isDragging = false; }
        function updateUI() {
            layersConfig.forEach((l, i) => document.getElementById(l.id).style.transform = `rotate(${state.rotations[i]}deg)`);
        }

        function resetCompass() { state.rotations = [0, 0, 0, 0]; updateUI(); }

        function setCondition(condition) {
            state.condition = condition;
            calculateAndAlign(); // é‡æ–°è®¡ç®—å¼€ç©´
        }

        function calculateAndAlign(customDate = null) {
            const now = customDate || new Date();
            const gz = getGanZhi(now);

            // 1. å­åˆæµæ³¨å¯¹é½ (åœ°æ”¯)
            const targetRotZiWu = -(gz.hourIndex * 30);

            // 2. çµé¾Ÿå…«æ³•è®¡ç®—
            // ä½¿ç”¨é€æ—¥å¹²æ”¯é…æ•°å’Œä¸´æ—¶å¹²æ”¯é…æ•°
            const lingguiSum = dayStemValues[gz.dayStem] + dayBranchValues[gz.dayBranch] + hourStemValues[gz.hourStem] + hourBranchValues[gz.hourBranch];

            // åˆ¤æ–­é˜³æ—¥æˆ–é˜´æ—¥
            const yangStems = ["ç”²", "ä¸™", "æˆŠ", "åºš", "å£¬"];
            const isYangDay = yangStems.includes(gz.dayStem);

            let lingguiRemainder;
            if (isYangDay) {
                // é˜³æ—¥é™¤ä»¥9
                lingguiRemainder = lingguiSum % 9;
                if (lingguiRemainder === 0) lingguiRemainder = 9;
            } else {
                // é˜´æ—¥é™¤ä»¥6
                lingguiRemainder = lingguiSum % 6;
                if (lingguiRemainder === 0) lingguiRemainder = 6;
            }

            const lingguiPoint = trigramPoints[lingguiRemainder];

            // è®¡ç®—ç›®æ ‡æ—‹è½¬è§’åº¦
            // å¦‚æœä½™æ•°æ˜¯5 (ä¸­äº”)ï¼Œåˆ™å¯„äºå¤äºŒ
            const targetNum = (lingguiRemainder === 5) ? 2 : lingguiRemainder;
            // æ‰¾åˆ°è¯¥å¦åœ¨ç½—ç›˜ä¸Šçš„ç´¢å¼•ä½ç½®
            const pointIdx = compassOrder.indexOf(targetNum);
            const targetRotBaFa = -(pointIdx * 45);

            // 3. é£è…¾å…«æ³•è®¡ç®— - ç›´æ¥ç”¨æ—¶å¹²å†³å®š
            const feitengPoint = feitengPoints[gz.hourStem];

            // 4. çº³å­æ³•è®¡ç®—
            const naZiData = naZiPoints[gz.hourIndex];

            state.rotations = [targetRotZiWu, targetRotBaFa, targetRotZiWu, targetRotZiWu];
            updateUI();

            // çº³ç”²æ³•å¼€ç©´
            const naJiaPoint = naJiaPoints[gz.dayStem] && naJiaPoints[gz.dayStem][gz.hourBranch] ? naJiaPoints[gz.dayStem][gz.hourBranch] : 'å¾…è¡¥å……';

            const dateLabel = customDate ? 'æŒ‡å®šæ—¶é—´' : 'ä»Šæ—¥å†æ³•';

            document.getElementById('info').innerHTML = `
                <div style="margin-bottom: 6px; font-size: 0.9rem;">ğŸ“… <b>${dateLabel}</b>ï¼š${gz.dayStem}${gz.dayBranch}æ—¥ ${gz.hourStem}${gz.hourBranch}æ—¶</div>
                
                <div style="margin-bottom: 6px; padding: 6px; background: rgba(166,124,0,0.1); border-radius: 4px; font-size: 0.85rem;">
                    <b>ğŸ©¸ å­åˆæµæ³¨ - çº³ç”²æ³•</b><br>
                    ${gz.dayStem}æ—¥ ${gz.hourBranch}æ—¶ï¼š<span class="highlight">${naJiaPoint}</span>
                </div>
                
                <div style="margin-bottom: 6px; padding: 6px; background: rgba(255,165,0,0.1); border-radius: 4px; font-size: 0.85rem;">
                    <b>ğŸ©¸ å­åˆæµæ³¨ - çº³å­æ³•</b><br>
                    ${naZiData.time}æ—¶ <span class="highlight">${naZiData.organ}</span> (${naZiData.wuxing}å±æ€§)<br>
                    è™šè¯ï¼š<span class="highlight">${naZiData.deficiency}</span> | å®è¯ï¼š<span class="highlight">${naZiData.excess}</span><br>
                    æœ¬ç©´ï¼š<span class="highlight">${naZiData.ben}</span> | åŸç©´ï¼š<span class="highlight">${naZiData.yuan}</span>
                </div>
                
                <div style="margin-bottom: 6px; padding: 6px; background: rgba(0,100,0,0.1); border-radius: 4px; font-size: 0.85rem;">
                    <b>ğŸ¢ çµé¾Ÿå…«æ³•</b> (é…æ•°å’Œ=${lingguiSum})<br>
                    å± <span class="gold-highlight">${lingguiPoint.d}</span> å¦ï¼Œå¼€ <span class="gold-highlight">${lingguiPoint.m}</span> (é€š${lingguiPoint.s})
                </div>
                
                <div style="padding: 6px; background: rgba(0,0,139,0.1); border-radius: 4px; font-size: 0.85rem;">
                    <b>ğŸ¦… é£è…¾å…«æ³•</b> (æ—¶å¹²=${gz.hourStem})<br>
                    å± <span class="gold-highlight">${feitengPoint.d}</span> å¦ï¼Œå¼€ <span class="gold-highlight">${feitengPoint.m}</span> (é€š${feitengPoint.s})
                </div>
            `;
        }

        function calculateForCustomDate() {
            const dateTimeInput = document.getElementById('customDateTime').value;
            if (!dateTimeInput) {
                alert('è¯·é€‰æ‹©æ—¥æœŸå’Œæ—¶é—´');
                return;
            }
            const customDate = new Date(dateTimeInput);
            calculateAndAlign(customDate);
        }

        init();
    </script>
</body>

</html>